<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AnimationScene Test</title>
</head>
<body>
  <h1>AnimationScene Test</h1>
  <div id="output"></div>

  <script type="module">
    import { AnimationScene } from './animation-scene.js';
    import { AnimationDate } from './animation-date.js';

    // Helper to log to page
    function log(msg) {
      document.getElementById('output').innerHTML += `<pre>${msg}</pre>`;
    }

    function assert(condition, message, ...args) {
      if (!condition) {
        console.error(message || "Assertion failed", ...args);
        return false;
      }
      return true;
    }
    function assertNull(obj) {
      assert(!obj, "assertNull(obj)", obj);
    }
    function assertNotNull(obj) {
      assert(obj, "assertNotNull(obj)", obj);
    }
    function assertThrowTyped(errorType, operation, ...args) {
      let thrownErr = null;
      try {
        operation(...args);
      } catch (error) {
        thrownErr = error;
      } finally {
        if (errorType) {
          assert(thrownErr instanceof errorType, "assertThrow(errorType, operation, ...args): expected error of type", errorType.name, "but got:", thrownErr, errorType, operation, ...args);
        } else {
          assertNotNull(thrownErr, "assertThrow(errorType, operation, ...args): expected some error but none was thrown", errorType, operation, ...args);
        }
      }
    }
    function assertThrow(operation, ...args) {
      assertThrowTyped(null, operation, ...args);
    }
    function assertEqual(obj1, obj2) {
      assert(obj1 === obj2, "assertEqual(obj1, obj2)", obj1, obj2);
    }
    function assertNotEqual(obj1, obj2) {
      assert(obj1 !== obj2, "assertNotEqual(obj1, obj2)", obj1, obj2);
    }
    function assertLessThan(obj1, obj2) {
      assert(obj1 < obj2, "assertLessThan(obj1, obj2)", obj1, obj2);
    }
    function assertLessOrEqualThan(obj1, obj2) {
      assert(obj1 < obj2 || obj1 === obj2, "assertLessOrEqualThan(obj1, obj2)", obj1, obj2);
    }
    function assertGreaterThan(obj1, obj2) {
      assert(obj1 > obj2, "assertGreaterThan(obj1, obj2)", obj1, obj2);
    }
    function assertGreaterOrEqualThan(obj1, obj2) {
      assert(obj1 > obj2 || obj1 === obj2, "assertGreaterOrEqualThan(obj1, obj2)", obj1, obj2);
    }

    function assertEqualDate(obj1, obj2) {
      assert(obj1.getTime() === obj2.getTime(), `assertEqualDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }
    function assertNotEqualDate(obj1, obj2) {
      assert(obj1.getTime() !== obj2.getTime(), `assertNotEqualDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }
    function assertLessThanDate(obj1, obj2) {
      assert(obj1.getTime() < obj2.getTime(), `assertLessThanDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }
    function assertLessOrEqualThanDate(obj1, obj2) {
      assert(obj1.getTime() < obj2.getTime() || obj1.getTime() === obj2.getTime(), `assertLessOrEqualThanDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }
    function assertGreaterThanDate(obj1, obj2) {
      assert(obj1.getTime() > obj2.getTime(), `assertGreaterThanDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }
    function assertGreaterOrEqualThanDate(obj1, obj2) {
      assert(obj1.getTime() > obj2.getTime() || obj1.getTime() === obj2.getTime(), `assertGreaterOrEqualThanDate(obj1, obj2): obj1.time:${obj1.getTime()}, obj2.time:${obj2.getTime()}`, obj1, obj2);
    }

    function truncateToSecond(date) {
      return new Date(
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
        date.getMinutes(),
        date.getSeconds()
      );
    }

    function getNow() {
      return truncateToSecond(new Date());
    }

    function testAnimationDateNullConfig() {
      log("testAnimationDateNullConfig");

      // Given
      const animationDate = new AnimationDate();

      // When

      // Then
      const date = AnimationDate.toDate(animationDate);

      // Assert
      assertNotNull(animationDate);
      assertNull(animationDate.getYear()); 
      assertNull(animationDate.getMonth()); 
      assertNull(animationDate.getDay()); 
      assertNull(animationDate.getHour()); 
      assertNull(animationDate.getMinute()); 
      assertNull(animationDate.getSecond());

      assertNotNull(date); // Random date
    }
    testAnimationDateNullConfig();

    function testAnimationDateEmptyConfig() {
      log("testAnimationDateEmptyConfig");
      // Given
      const animationDate = new AnimationDate({});

      // When

      // Then
      const date = AnimationDate.toDate(animationDate);

      // Assert
      assertNotNull(animationDate);
      assertNull(animationDate.getYear());
      assertNull(animationDate.getMonth());
      assertNull(animationDate.getDay());
      assertNull(animationDate.getHour());
      assertNull(animationDate.getMinute());
      assertNull(animationDate.getSecond());

      assertNotNull(date); // Random date
    }
    testAnimationDateEmptyConfig();

    function testAnimationDatePartialConfig() {
      log("testAnimationDatePartialConfig");
      // Given
      const animationDate = new AnimationDate({month: 11, minute: 53, second: 2});

      // When

      // Then
      const date = AnimationDate.toDate(animationDate);

      // Assert
      assertNotNull(animationDate);
      assertNull(animationDate.getYear());
      assertEqual(animationDate.getMonth(), 11);
      assertNull(animationDate.getDay());
      assertNull(animationDate.getHour());
      assertEqual(animationDate.getMinute(), 53);
      assertEqual(animationDate.getSecond(), 2);

      assertNotNull(date); // Random date
    }
    testAnimationDatePartialConfig();

    function testAnimationDateFullConfig() {
      log("testAnimationDateFullConfig");
      // Given
      const animationDate = new AnimationDate({year: 2025, month: 11, day: 7, hour: 14, minute: 53, second: 2});

      // When

      // Then
      const date = AnimationDate.toDate(animationDate);

      // Assert
      assertNotNull(animationDate);
      assertEqual(animationDate.getYear(), 2025);
      assertEqual(animationDate.getMonth(), 11);
      assertEqual(animationDate.getDay(), 7);
      assertEqual(animationDate.getHour(), 14);
      assertEqual(animationDate.getMinute(), 53);
      assertEqual(animationDate.getSecond(), 2);

      assertNotNull(date);
      assertEqual(date.getFullYear(), 2025);
      assertEqual(date.getMonth() + 1, 11);
      assertEqual(date.getDate(), 7);
      assertEqual(date.getHours(), 14);
      assertEqual(date.getMinutes(), 53);
      assertEqual(date.getSeconds(), 2);
    }
    testAnimationDateFullConfig();

    function testAnimationDateFullConfigPartialOverride() {
      log("testAnimationDateFullConfigPartialOverride");
      // Given
      const animationDate = new AnimationDate({year: 2025, month: 11, day: 7, hour: 14, minute: 53, second: 2});

      // When
      animationDate.setYear(2026);
      animationDate.setHour(1);

      // Then
      const date = AnimationDate.toDate(animationDate);

      // Assert
      assertNotNull(animationDate);
      assertEqual(animationDate.getYear(), 2026);
      assertEqual(animationDate.getMonth(), 11);
      assertEqual(animationDate.getDay(), 7);
      assertEqual(animationDate.getHour(), 1);
      assertEqual(animationDate.getMinute(), 53);
      assertEqual(animationDate.getSecond(), 2);

      assertNotNull(date);
      assertEqual(date.getFullYear(), 2026);
      assertEqual(date.getMonth() + 1, 11);
      assertEqual(date.getDate(), 7);
      assertEqual(date.getHours(), 1);
      assertEqual(date.getMinutes(), 53);
      assertEqual(date.getSeconds(), 2);
    }
    testAnimationDateFullConfigPartialOverride();

    function testAnimationSceneIdentity() {
      log("testAnimationSceneIdentity");
      // Given
      const dateNow = getNow();
      const config = null;

      // When
      const scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);
    }
    testAnimationSceneIdentity();
    
    function testAnimationSceneBothEmpty() {
      log("testAnimationSceneBothEmpty");
      // Given
      const dateNow = getNow();
      const config = {
        date_start: {},
        date_end: {}
      };

      // When
      const scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);
    }
    testAnimationSceneBothEmpty();

    function testAnimationSceneBothFullEqual() {
      log("testAnimationSceneBothFullEqual");

      // Given
      const config = {
        date_start: { year: 2025, month: 9, day: 8, hour: 23, minute: 59, second: 59 },
        date_end: { year: 2025, month: 9, day: 8, hour: 23, minute: 59, second: 59 }
      };

      // When
      let scene;
      assertThrowTyped(RangeError, () => scene = new AnimationScene(config));

      // Then

      // Assert
      assertNull(scene);
    }
    testAnimationSceneBothFullEqual();

    function testAnimationSceneBothSecondEqual() {
      log("testAnimationSceneBothSecondEqual");
      const dateNow = getNow();
      const now = AnimationDate.fromDate(dateNow);

      // Given
      const config = {
        date_start: { second: 59 },
        date_end: { second: 59 }
      };

      // When
      let scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);

      assertNotNull(dateEnd);
      assertEqual(dateEnd.getFullYear(), now.getYear());
      assertEqual(dateEnd.getMonth() + 1, now.getMonth());
      assertEqual(dateEnd.getDate(), now.getDay());
      assertEqual(dateEnd.getHours(), now.getHour());
      assertEqual(dateEnd.getMinutes(), now.getMinute());
      assertEqual(dateEnd.getSeconds(), 59);

      assertEqual(dateEnd - dateStart, 60000); // 1 minute = 60000 ms
    }
    testAnimationSceneBothSecondEqual();

    function testAnimationSceneBothMinuteEqual() {
      log("testAnimationSceneBothMinuteEqual");
      const dateNow = getNow();
      const now = AnimationDate.fromDate(dateNow);

      // Given
      const config = {
        date_start: { minute: 59 },
        date_end: { minute: 59 }
      };

      // When
      let scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);

      assertNotNull(dateEnd);
      assertEqual(dateEnd.getFullYear(), now.getYear());
      assertEqual(dateEnd.getMonth() + 1, now.getMonth());
      assertEqual(dateEnd.getDate(), now.getDay());
      assertEqual(dateEnd.getHours(), now.getHour());
      assertEqual(dateEnd.getMinutes(), 59);
      assertEqual(dateEnd.getSeconds(), 0);

      assertEqual(dateEnd - dateStart, 3600000); // 1 hour = 3600000 ms
    }
    testAnimationSceneBothMinuteEqual();

    function testAnimationSceneBothHourEqual() {
      log("testAnimationSceneBothHourEqual");
      const dateNow = getNow();
      const now = AnimationDate.fromDate(dateNow);

      // Given
      const config = {
        date_start: { hour: 23 },
        date_end: { hour: 23 }
      };

      // When
      let scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);

      assertNotNull(dateEnd);
      assertEqual(dateEnd.getFullYear(), now.getYear());
      assertEqual(dateEnd.getMonth() + 1, now.getMonth());
      assertEqual(dateEnd.getDate(), now.getDay());
      assertEqual(dateEnd.getHours(), 23);
      assertEqual(dateEnd.getMinutes(), 0);
      assertEqual(dateEnd.getSeconds(), 0);

      assertEqual(dateEnd - dateStart, 86400000); // 1 day = 86400000 ms
    }
    testAnimationSceneBothHourEqual();

    function testAnimationSceneBothDayEqual28() {
      log("testAnimationSceneBothDayEqual28");
      const dateNow = getNow();
      const now = AnimationDate.fromDate(dateNow);

      // Given
      const config = {
        date_start: { day: 28 },
        date_end: { day: 28 }
      };

      // When
      let scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);

      assertNotNull(dateEnd);
      assertEqual(dateEnd.getFullYear(), now.getYear());
      assertEqual(dateEnd.getMonth() + 1, now.getMonth());
      assertEqual(dateEnd.getDate(), 28);
      assertEqual(dateEnd.getHours(), 0);
      assertEqual(dateEnd.getMinutes(), 0);
      assertEqual(dateEnd.getSeconds(), 0);

      assertEqual(dateEnd - dateStart, 2419200000); // 1 month of 28 days = 2419200000 ms
      assertLessOrEqualThan(dateEnd - dateStart, 2678400000); // 1 month of 31 days = 2678400000 ms
    }
    testAnimationSceneBothDayEqual28();

    function testAnimationSceneBothDayEqual31() {
      log("testAnimationSceneBothDayEqual31");
      const dateNow = getNow();
      const now = AnimationDate.fromDate(dateNow);

      // Given
      const config = {
        date_start: { day: 31 },
        date_end: { day: 31 }
      };

      // When
      let scene = new AnimationScene(config);

      // Then
      const dateStart = AnimationDate.toDate(scene.getDateStart());
      const dateEnd = AnimationDate.toDate(scene.getDateEnd());

      // Assert
      assertNotNull(scene);
      assertNotNull(dateStart);
      assertNotNull(dateEnd);
      assertLessThanDate(dateStart, dateEnd);
      assertLessOrEqualThanDate(dateStart, dateNow);
      assertGreaterOrEqualThanDate(dateEnd, dateNow);

      assertNotNull(dateEnd);
      assertEqual(dateEnd.getFullYear(), now.getYear());
      assertEqual(dateEnd.getMonth() + 1, now.getMonth());
      assertEqual(dateEnd.getDate(), 31);
      assertEqual(dateEnd.getHours(), 0);
      assertEqual(dateEnd.getMinutes(), 0);
      assertEqual(dateEnd.getSeconds(), 0);

      assertGreaterOrEqualThan(dateEnd - dateStart, 2678400000); // 1 month of 31 days = 2678400000 ms
      assertLessOrEqualThan(dateEnd - dateStart, 5356800000); // 2 months of 31 days = 5356800000 ms
    }
    testAnimationSceneBothDayEqual31();

  </script>
</body>
</html>
